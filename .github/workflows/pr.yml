name: validation
on:
  pull_request:
    branches:
      - main
jobs:
  find:
    name: find
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout flux-github-actions
        uses: actions/checkout@v3
        # with: 
        #   path: flux-github-actions
      - name: Checkout flux-github-actions-test
        uses: actions/checkout@v3
        with:
          path: flux-github-actions-test
          fetch-depth: 0
          repository: 'differenzierbar/flux-github-actions-test'
          ref: main
      - name: install
        run: |
          sudo apt-get install jq jo
          curl -L https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv4.5.7/kustomize_v4.5.7_linux_amd64.tar.gz | sudo tar -xz -C /usr/local/bin
      - name: find kustomization changes
        id: find_kustomization_changes
        uses: "./kustomize-changes"
        with:
          changes: kustomizations/invalid/kustomization.yaml
          kustomizations-root: ./flux-github-actions-test
      - name: set matrix
        id: set-matrix
        run: |
          set -ex
          jo --help
          echo "::set-output name=matrix::{\"kustomization\": $(jo -a ${{ steps.find_kustomization_changes.outputs.kustomization-changes }})}"
      # - name: kustomize validation
      #   uses: "./kustomize-validation"
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     git_sha: ${{ github.event.pull_request.head.sha }}
      #     kustomizations: ${{ steps.find_kustomization_changes.outputs.kustomization-changes }}
      #     kustomization_root: ./flux-github-actions-test
  validation:
    needs: find
    runs-on: ubuntu-22.04
    strategy:
      matrix: ${{fromJSON(needs.find.outputs.matrix)}}
    steps:
      - run: |
          echo ${{ matrix.kustomization }}
